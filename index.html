<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TICV Web Simulator | Research & Learning Portal</title>
    <!-- Libraries via CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-deep: #05070a;
            --accent-gold: #c5a059;
            --accent-blue: #3a86ff;
            --text-main: #e0e0e0;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --sidebar-width: 320px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            background: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            display: flex;
            height: 100vh;
        }

        /* SIDEBAR */
        #sidebar {
            width: var(--sidebar-width);
            background: rgba(0, 0, 0, 0.3);
            border-right: 1px solid var(--glass-border);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            z-index: 100;
        }

        .brand h1 {
            font-size: 1.2rem;
            font-weight: 800;
            letter-spacing: 2px;
            color: var(--accent-gold);
        }

        .brand p {
            font-size: 0.7rem;
            opacity: 0.5;
            text-transform: uppercase;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-group label {
            font-size: 0.75rem;
            font-weight: 600;
            opacity: 0.7;
            display: flex;
            justify-content: space-between;
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            background: var(--glass-border);
            border-radius: 2px;
            appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 12px;
            height: 12px;
            background: var(--accent-gold);
            border-radius: 50%;
        }

        .btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.85rem;
            text-align: center;
        }

        .btn:hover {
            background: var(--glass-border);
            border-color: var(--accent-gold);
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-gold);
            color: black;
            border: none;
        }

        .btn-primary:hover {
            background: white;
        }

        /* MAIN CONTENT */
        #main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 12px;
            padding: 12px;
            position: relative;
        }

        .card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            padding: 12px 16px;
            font-size: 0.7rem;
            font-weight: 800;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.02);
        }

        .card-content {
            flex: 1;
            position: relative;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        /* TELEMETRY OVERLAY */
        #telemetry-overlay {
            position: absolute;
            top: 24px;
            right: 24px;
            background: rgba(0, 0, 0, 0.6);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
            backdrop-filter: blur(10px);
            z-index: 50;
        }

        .tel-item {
            display: flex;
            justify-content: space-between;
            gap: 40px;
        }

        .tel-val {
            color: var(--accent-gold);
        }

        /* TUTORIAL OVERLAY */
        #tutorial-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            transition: opacity 0.5s;
        }

        .tutorial-card {
            background: #0d1117;
            border: 1px solid var(--accent-gold);
            width: 450px;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .tutorial-step {
            font-size: 0.7rem;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .tutorial-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 20px;
        }

        .tutorial-text {
            font-size: 0.95rem;
            line-height: 1.6;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        .highlight {
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7), 0 0 20px var(--accent-gold) !important;
            z-index: 1001 !important;
            border-color: var(--accent-gold) !important;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 2px;
        }
    </style>
</head>

<body>

    <!-- TUTORIAL LAYER -->
    <div id="tutorial-layer">
        <div class="tutorial-card">
            <div id="tutorial-step-label" class="tutorial-step">Bienvenido</div>
            <div id="tutorial-title" class="tutorial-title">Iniciación TICV</div>
            <p id="tutorial-text" class="tutorial-text">
                Estás a punto de entrar en el simulador del vacío. Antes de investigar, debes comprender los principios
                fundamentales de la Teoría de la Información Cuántica del Vacío.
            </p>
            <button class="btn btn-primary" id="btn-tutorial-next" style="width: 100%">COMENZAR APRENDIZAJE</button>
        </div>
    </div>

    <aside id="sidebar">
        <div class="brand">
            <h1>TICV KERNEL E-2</h1>
            <p>Research & Learning Portal</p>
        </div>

        <div class="control-group" id="ctrl-n">
            <label>Nodos del Sistema <span id="val-n">500</span></label>
            <input type="range" id="input-n" min="100" max="1500" step="100" value="500">
        </div>

        <div class="control-group" id="ctrl-r">
            <label>Reactividad (r) <span id="val-r">0.08</span></label>
            <input type="range" id="input-r" min="0.01" max="0.5" step="0.01" value="0.08">
        </div>

        <div class="control-group" id="ctrl-k">
            <label>Saturación (κ) <span id="val-k">0.90</span></label>
            <input type="range" id="input-k" min="0.1" max="1.5" step="0.05" value="0.9">
        </div>

        <hr style="opacity: 0.1">

        <button class="btn btn-primary" id="btn-start" disabled>BIG BANG (RESET)</button>
        <button class="btn" id="btn-pause" disabled>PAUSAR SIMULACIÓN</button>
        <button class="btn" id="btn-export" disabled>EXPORTAR DATOS (CSV)</button>

        <div style="flex: 1"></div>

        <div class="card" style="height: auto; padding: 12px; font-size: 0.7rem; line-height: 1.4; opacity: 0.6;">
            <strong>Manual de Usuario:</strong> Completa el tutorial interactivo para desbloquear los controles de
            investigación avanzada.
        </div>
    </aside>

    <main id="main">
        <!-- 2D HEATMAP -->
        <section class="card" id="card-2d">
            <div class="card-header">
                <span>MATRIZ C - INTENSIDAD DE CONECTIVIDAD</span>
                <span style="opacity: 0.5">2D VIEW</span>
            </div>
            <div class="card-content">
                <canvas id="canvas-heatmap"></canvas>
            </div>
        </section>

        <!-- 3D TOPOLOGY -->
        <section class="card" id="card-3d">
            <div class="card-header">
                <span>TOPOLOGÍA RELACIONAL EMERGENTE</span>
                <span style="opacity: 0.5">3D GRAPH</span>
            </div>
            <div class="card-content" id="visualizer-3d"></div>
        </section>

        <!-- CHARTS -->
        <section class="card" style="grid-column: span 2" id="card-charts">
            <div class="card-header">
                <span>TELEMETRÍA EVOLUTIVA</span>
                <span id="step-counter">PASO: 0</span>
            </div>
            <div class="card-content" style="padding: 20px;">
                <canvas id="canvas-telemetry"></canvas>
            </div>
        </section>

        <!-- FLOATING OVERLAY -->
        <div id="telemetry-overlay">
            <div class="tel-item"><span>Norma Frobenius ||C||</span> <span class="tel-val" id="tel-norm">0.000</span>
            </div>
            <div class="tel-item"><span>Flujo sintrópico ΔG</span> <span class="tel-val" id="tel-flux">0.000</span>
            </div>
            <div class="tel-item"><span>Clase Atractora</span> <span class="tel-val"
                    id="tel-class">DETERMINING...</span></div>
        </div>
    </main>

    <script id="worker-script" type="application/javascript">
        let N = 0;
        let C = null;
        let E = null;
        let r = 0.08;
        let k = 0.9;
        let stepCount = 0;

        self.onmessage = function (e) {
            const { type, payload } = e.data;
            if (type === 'init') {
                N = payload.N;
                r = payload.r;
                k = payload.k;
                C = new Float32Array(N * N);
                E = new Float32Array(N);
                for (let i = 0; i < N * N; i++) {
                    if (Math.random() < 0.05) C[i] = Math.random() * 0.1;
                }
                stepCount = 0;
            }
            if (type === 'update_params') {
                r = payload.r;
                k = payload.k;
            }
            if (type === 'step') {
                runStep();
            }
        };

        function runStep() {
            E.fill(0);
            for (let i = 0; i < N; i++) {
                for (let j = 0; j < N; j++) {
                    E[i] += C[i * N + j];
                }
            }
            let totalChange = 0;
            let normSq = 0;
            for (let i = 0; i < N; i++) {
                for (let j = i + 1; j < N; j++) {
                    const idx = i * N + j;
                    const idxRev = j * N + i;
                    const phi = 1.0 / (1.0 + Math.abs(E[i] - E[j]));
                    const delta = r * phi * (k - C[idx]);
                    C[idx] += delta;
                    C[idxRev] = C[idx];
                    totalChange += Math.abs(delta);
                    normSq += C[idx] * C[idx];
                }
            }
            stepCount++;
            const norm = Math.sqrt(normSq);
            const gFlux = totalChange / (N * N);
            let classLabel = "ALPHA (INCUBATING)";
            if (gFlux < 0.001) {
                classLabel = (norm > 0.5 * N) ? "CLASS C (DENSE)" : "CLASS B (MODULAR)";
            } else if (gFlux > 0.05) {
                classLabel = "CLASS D (GRADIENT)";
            }
            self.postMessage({
                type: 'frame',
                payload: { C, norm, gFlux, step: stepCount, class: classLabel }
            });
        }
    </script>

    <script>
        // --- WEB WORKER SETUP ---
        // Convertimos el contenido del script en una URL de datos Base64
        const workerScript = document.getElementById('worker-script').textContent;
        const blob = new Blob([workerScript], { type: 'application/javascript' });
        const worker = new Worker(URL.createObjectURL(blob));

        // --- DOM ELEMENTS ---
        const ui = {
            inputN: document.getElementById('input-n'),
            inputR: document.getElementById('input-r'),
            inputK: document.getElementById('input-k'),
            valN: document.getElementById('val-n'),
            valR: document.getElementById('val-r'),
            valK: document.getElementById('val-k'),
            btnStart: document.getElementById('btn-start'),
            btnPause: document.getElementById('btn-pause'),
            telNorm: document.getElementById('tel-norm'),
            telFlux: document.getElementById('tel-flux'),
            telClass: document.getElementById('tel-class'),
            stepCounter: document.getElementById('step-counter'),
            tutorialLayer: document.getElementById('tutorial-layer'),
            tutorialNext: document.getElementById('btn-tutorial-next'),
            tutorialTitle: document.getElementById('tutorial-title'),
            tutorialText: document.getElementById('tutorial-text'),
            tutorialLabel: document.getElementById('tutorial-step-label')
        };

        let isPaused = true;
        let config = { N: 500, r: 0.08, k: 0.9 };
        let tutorialStep = 0;

        // --- FUNCIONES DE APOYO ---
        function updateParams() {
            config.r = parseFloat(ui.inputR.value);
            config.k = parseFloat(ui.inputK.value);
            worker.postMessage({ type: 'update_params', payload: config });
        }

        function animateSlider(id, targetValue) {
            const input = document.getElementById(id);
            const valDisplay = document.getElementById('val-' + id.split('-')[1]);
            const startValue = parseFloat(input.value);
            const duration = 1000;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = startValue + (targetValue - startValue) * progress;
                input.value = current;
                if (valDisplay) valDisplay.textContent = current.toFixed(2);
                updateParams();
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        // --- TUTORIAL LOGIC ---
        const tutorialFlow = [
            {
                label: "Paso 1: El Vacubit",
                title: "La Unidad Mínima",
                text: "En TICV no existe la materia... Mira el visualizador 3D: cada punto es un Vacubit esperando conectarse.",
                highlight: "card-3d",
                action: () => { }
            },
            {
                label: "Paso 2: La Red",
                title: "Matriz de Conectividad",
                text: "La realidad es el patrón de vínculos... Los colores brillantes indican vínculos fuertes.",
                highlight: "card-2d",
                action: () => { }
            },
            {
                label: "Paso 3: El Kernel E-2",
                title: "La Ley del Vacío",
                text: "Al aumentar la Reactividad (r), los nodos se atraen más rápido. ¡Mira cómo se activan los controles!",
                highlight: "ctrl-r",
                action: () => { }
            },
            {
                label: "Experimento: Génesis",
                title: "El Big Bang",
                text: "Haz clic en 'BIG BANG' para resetear la matriz a un estado de caos primordial.",
                highlight: "btn-start",
                action: () => { ui.btnStart.disabled = false; }
            },
            {
                label: "Experimento: Estabilización",
                title: "Metaestabilización",
                text: "Ajustando parámetros automáticamente para alcanzar el equilibrio sintrópico...",
                highlight: "ctrl-k",
                action: () => {
                    ui.btnPause.disabled = false;
                    isPaused = false;
                    animateSlider('input-r', 0.05);
                    animateSlider('input-k', 1.00);
                    loop();
                }
            },
            {
                label: "Conclusión",
                title: "Atractores y Realidad",
                text: "¡Felicidades! Has desbloqueado todas las herramientas de investigación.",
                highlight: "telemetry-overlay",
                action: () => {
                    ui.btnStart.disabled = false;
                    document.getElementById('btn-export').disabled = false;
                }
            }
        ];

        ui.tutorialNext.onclick = function () {
            if (tutorialStep >= tutorialFlow.length) {
                completeTutorial();
                return;
            }

            const step = tutorialFlow[tutorialStep];
            ui.tutorialLabel.textContent = step.label;
            ui.tutorialTitle.textContent = step.title;
            ui.tutorialText.textContent = step.text;

            document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
            const target = document.getElementById(step.highlight);
            if (target) target.classList.add('highlight');

            step.action();
            tutorialStep++;

            ui.tutorialNext.textContent = (tutorialStep === tutorialFlow.length) ? "FINALIZAR" : "SIGUIENTE";
        };

        function completeTutorial() {
            ui.tutorialLayer.style.opacity = '0';
            setTimeout(() => {
                ui.tutorialLayer.style.display = 'none';
                document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
                ui.btnStart.disabled = false;
                ui.btnPause.disabled = false;
                document.getElementById('btn-export').disabled = false;
            }, 500);
        }

        // --- VISUALS (HEATMAP & 3D) ---
        const canvas2d = document.getElementById('canvas-heatmap');
        const ctx2d = canvas2d.getContext('2d');

        function drawHeatmap(C, N) {
            canvas2d.width = N; canvas2d.height = N;
            const imgData = ctx2d.createImageData(N, N);
            for (let i = 0; i < N * N; i++) {
                const val = Math.floor(C[i] * 255);
                const idx = i * 4;
                imgData.data[idx] = val;
                imgData.data[idx + 1] = val * 0.6;
                imgData.data[idx + 2] = val * 0.4;
                imgData.data[idx + 3] = 255;
            }
            ctx2d.putImageData(imgData, 0, 0);
        }

        const container3d = document.getElementById('visualizer-3d');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        container3d.appendChild(renderer.domElement);
        camera.position.z = 200;

        const pointsGeometry = new THREE.BufferGeometry();
        const pointsMaterial = new THREE.PointsMaterial({ color: 0xc5a059, size: 2, transparent: true, opacity: 0.8 });
        const points = new THREE.Points(pointsGeometry, pointsMaterial);
        scene.add(points);

        function update3D(C, N) {
            const positions = new Float32Array(N * 3);
            for (let i = 0; i < N; i++) {
                const angle = (i / N) * Math.PI * 2;
                let rSum = 0;
                for (let j = 0; j < N; j++) rSum += C[i * N + j];
                const radius = 100 - (rSum * 0.2);
                positions[i * 3] = Math.cos(angle) * radius;
                positions[i * 3 + 1] = Math.sin(angle) * radius;
                positions[i * 3 + 2] = (Math.random() - 0.5) * 20;
            }
            pointsGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        }

        function resize3D() {
            if (!container3d.clientWidth) return;
            renderer.setSize(container3d.clientWidth, container3d.clientHeight);
            camera.aspect = container3d.clientWidth / container3d.clientHeight;
            camera.updateProjectionMatrix();
        }
        window.addEventListener('resize', resize3D);
        resize3D();

        // --- CHARTS ---
        const chartCtx = document.getElementById('canvas-telemetry').getContext('2d');
        const telemetryChart = new Chart(chartCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Norma ||C||', data: [], borderColor: '#c5a059', yAxisID: 'y', tension: 0.4 },
                    { label: 'Flujo G', data: [], borderColor: '#3a86ff', borderDash: [5, 5], yAxisID: 'y1', tension: 0.4 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { type: 'linear', position: 'left', grid: { color: 'rgba(255,255,255,0.05)' } },
                    y1: { type: 'linear', position: 'right', grid: { display: false } }
                },
                plugins: { legend: { labels: { color: '#aaa', font: { size: 10 } } } }
            }
        });

        // --- SIMULATION CONTROL ---
        function initSimulation() {
            config.N = parseInt(ui.inputN.value);
            config.r = parseFloat(ui.inputR.value);
            config.k = parseFloat(ui.inputK.value);

            // Limpiar gráfica
            telemetryChart.data.labels = [];
            telemetryChart.data.datasets[0].data = [];
            telemetryChart.data.datasets[1].data = [];
            telemetryChart.update();

            // 1. Enviamos los datos al Worker
            worker.postMessage({ type: 'init', payload: config });

            // 2. LA CHISPA: Forzamos el primer paso
            isPaused = false;
            worker.postMessage({ type: 'step' });
        }

        function loop() {
            if (!isPaused) {
                worker.postMessage({ type: 'step' });
            }
        }

        worker.onmessage = function (e) {
            const { type, payload } = e.data;
            if (type === 'frame') {
                drawHeatmap(payload.C, config.N);
                update3D(payload.C, config.N);

                ui.telNorm.textContent = payload.norm.toFixed(3);
                ui.telFlux.textContent = payload.gFlux.toFixed(5);
                ui.telClass.textContent = payload.class;
                ui.stepCounter.textContent = `PASO: ${payload.step}`;

                if (payload.step % 5 === 0) {
                    telemetryChart.data.labels.push(payload.step);
                    telemetryChart.data.datasets[0].data.push(payload.norm);
                    telemetryChart.data.datasets[1].data.push(payload.gFlux * 100);

                    if (telemetryChart.data.labels.length > 50) {
                        telemetryChart.data.labels.shift();
                        telemetryChart.data.datasets[0].data.shift();
                        telemetryChart.data.datasets[1].data.shift();
                    }
                    telemetryChart.update('none');
                }

                if (!isPaused) requestAnimationFrame(loop);
            }
        };

        // --- LISTENERS ---
        ui.inputN.oninput = () => ui.valN.textContent = ui.inputN.value;
        ui.inputR.oninput = () => { ui.valR.textContent = ui.inputR.value; updateParams(); };
        ui.inputK.oninput = () => { ui.valK.textContent = ui.inputK.value; updateParams(); };

        ui.btnStart.onclick = () => {
            isPaused = false;
            ui.btnPause.textContent = "PAUSAR SIMULACIÓN";
            initSimulation();
        };

        ui.btnPause.onclick = () => {
            isPaused = !isPaused;
            ui.btnPause.textContent = isPaused ? "CONTINUAR" : "PAUSAR SIMULACIÓN";
            if (!isPaused) loop();
        };

        function animateScene() {
            scene.rotation.y += 0.002;
            renderer.render(scene, camera);
            requestAnimationFrame(animateScene);
        }
        animateScene();

        // Boot Inicial
        initSimulation();
    </script>
</body>

</html>